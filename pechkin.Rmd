---
title: "Pechkin"
output: html_notebook
---

```{r}
library(tidyverse)
library(priceR)

raw_data <- read_csv("data/2023-07-15.csv")
with_prices_data <- raw_data %>% filter(!is.na(price))

normalized_data <- with_prices_data %>% mutate(
  `Новостройка` = case_when(
    `Новостройка` == "Да" ~ TRUE,
    `Новостройка` == "Нет" ~ FALSE
  ),
  
  `Лифт` = ifelse(`Лифт` == "Есть", TRUE, FALSE),
  price = str_replace_all(price, ",", ""),
  amount = as.numeric(str_extract(price, "\\d+")),
  currency = trimws(str_extract(price, "\\D+")),
  currency = case_when(
    currency == "$" ~ "USD",
    currency == "֏" ~ "AMD",
    currency == "€" ~ "EUR",
    TRUE ~ currency
  ),
  price_usd = convert_currencies(price_start = amount, from=currency, to="USD"),
  area = as.numeric(str_extract(`Общая площадь`, "\\d+")),
  height = as.numeric(str_extract(`Высота потолков`, "\\d+(.\\d+)?")),
  rooms=parse_number(`Количество комнат`),
  bathrooms=parse_number(`Количество санузлов`)
) %>% select(-price, -amount, -currency, -`Общая площадь`, -`Высота потолков`, -`Количество комнат`, -`Количество санузлов`)

normalized_data
```

```{r}
hex_plot <- normalized_data %>%
  ggplot(aes(longitude, latitude, z=price_usd)) +
  stat_summary_hex(alpha=0.8, bins=50) +
  scale_fill_viridis_c() + 
  labs(
    fill = "mean",
    title = "Price"
  )
hex_plot
```

```{r}
library(osmdata)
library(ggmap)

yerevan_bb <- getbb("Kentron")

yerevan_map <- get_stamenmap(yerevan_bb, zoom = 15)

ggmap(yerevan_map) +
  stat_summary_hex(
    data = normalized_data,
    aes(longitude, latitude, z = price_usd),
    alpha = 0.5,
    bins = 50
  ) +
  scale_fill_viridis_c() +
  labs(fill = "mean",
       title = "Price")
```

```{r}
library(dplyr)
library(ggplot2)
set.seed(23072023)
num_clusters <- 10

clustered_df <- normalized_data %>%
  select(latitude, longitude) %>%
  kmeans(nstart = 25, centers = num_clusters)

clustered <- normalized_data
clustered$cluster <- as.factor(clustered_df$cluster)

# Plot the clusters on a map
ggplot(clustered, aes(x = longitude, y = latitude, color = cluster)) +
  geom_point(size = 3) +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Location Clustering")
```
```{r}
not_in_yerevan <- clustered %>% filter(cluster %in% c(6,8))
not_in_yerevan
```
```{r}
apts_in_yerevan <- normalized_data %>% filter(!(id %in% not_in_yerevan$id))
apts_in_yerevan %>%
  ggplot(aes(longitude, latitude, z=price_usd)) +
  stat_summary_hex(alpha=0.8, bins=50) +
  scale_fill_viridis_c() + 
  labs(
    fill = "mean",
    title = "Price"
  )
```
```{r}
library(patchwork)

plot <- function(df, var, title) {
  df %>%
    ggplot(aes(longitude, latitude, z = {
      {
        var
      }
    })) +
    stat_summary_hex(alpha = 0.8, bins = 50) +
    scale_fill_viridis_c() +
    labs(fill = "mean",
         title = title)
}

(plot(apts_in_yerevan, price_usd, "Price") +
    plot(apts_in_yerevan, area, "Area")) /
  (
    plot(apts_in_yerevan, rooms, "Rooms") +
      plot(apts_in_yerevan, bathrooms, "Bathrooms")
  )
```
```{r}
library(tidytext)

yerevan_tidy <- apts_in_yerevan %>%
  unnest_tokens(word, summary) %>%
  anti_join(get_stopwords("ru"))

yerevan_tidy %>%
  count(word, sort = TRUE)
```

```{r}
top_words <-
  yerevan_tidy %>%
  count(word, sort = TRUE) %>%
  filter(!word %in% as.character(1:1000)) %>%
  slice_max(n, n = 100) %>%
  pull(word)

word_freqs <-
  yerevan_tidy %>%
  count(word, price_usd) %>%
  complete(word, price_usd, fill = list(n = 0)) %>%
  group_by(price_usd) %>%
  mutate(price_total = sum(n),
         proportion = n / price_total) %>%
  ungroup() %>%
  filter(word %in% top_words)

word_freqs
```
```{r}
word_mods <-
  word_freqs %>%
  nest(data = c(price_usd, n, price_total, proportion)) %>%
  mutate(model = map(data, ~ glm(
    cbind(n, price_total) ~ price_usd, ., family = "binomial"
  )),
  model = map(model, tidy)) %>%
  unnest(model) %>%
  filter(term == "price_usd")  %>%
  mutate(p.value = p.adjust(p.value)) %>%
  arrange(-estimate)

word_mods
```
```{r}
library(ggrepel)

word_mods %>%
  ggplot(aes(estimate, p.value)) +
  geom_vline(
    xintercept = 0,
    lty = 2,
    alpha = 0.7,
    color = "gray50"
  ) +
  geom_point(color = "midnightblue",
             alpha = 0.8,
             size = 2.5) +
  scale_y_log10() +
  geom_text_repel(aes(label = word))
```

